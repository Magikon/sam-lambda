Resources:

  CreateLead:
    Type: AWS::Serverless::Function
    Properties:
      Runtime: nodejs12.x
      Layers:
        - !Ref NodeJsLayer
      Handler: create.handler
      CodeUri: functions/leads_create
      MemorySize: 512
      Timeout: 300
      Tracing: Active
      Role:
        'Fn::GetAtt':
          - Role
          - Arn
      Policies:
        - LambdaInvokePolicy:
            FunctionName: !Ref Map
        - LambdaInvokePolicy:
            FunctionName: !Ref Recommend
        - SNSPublishMessagePolicy:
            TopicName: !GetAtt InsertLeadTopic.TopicName
        - SNSPublishMessagePolicy:
            TopicName: !GetAtt LogLeadTopic.TopicName
        - SNSPublishMessagePolicy:
            TopicName: !GetAtt LogLeadInTopic.TopicName
        - SNSPublishMessagePolicy:
            TopicName: !GetAtt ErrorNotificationTopic.TopicName
      Environment:
        Variables:
          ENV: !Ref Env
          TOPIC_INSERT_LEAD: !Ref InsertLeadTopic
          TOPIC_LOG_LEAD: !Ref LogLeadTopic
          TOPIC_LOG_LEAD_IN: !Ref LogLeadInTopic
          TOPIC_ERROR: !Ref ErrorNotificationTopic
          TOPIC_ROLLBAR: !Ref RollbarTopic
          FUNC_MAP: !Ref Map
          FUNC_RECOMMEND: !Ref Recommend
          REDSHIFT_ENDPOINT: !Ref RedshiftDBEndpoint
          REDSHIFT_DB_USER: !Ref RedshiftDBUser
          REDSHIFT_DB_NAME: !Ref RedshiftDBName
          REDSHIFT_DB_PORT: !Ref RedshiftDBPort
          BUCKET: !Ref ProPairBucketName
          VELOCIFY_URL: https://service.leads360.com/ClientService.asmx/
      VpcConfig: 
        SecurityGroupIds: 
          - sg-0b54841712c67143c
          - sg-0409e987266b33345
        SubnetIds: 
          - subnet-072fb25b65d0098f2
          - subnet-08702ed2157ee7951

      Events:
        LeadCreation:
          Type: Api
          Properties:
            Path: /leads
            Method: post
          Authorizer:
            Type: "AWS::ApiGateway::Authorizer"
            
  LeadsStream:
    Type: AWS::Serverless::Function
    Properties:
      Runtime: nodejs12.x
      Layers:
        - !Ref NodeJsLayer
      Handler: update.handler
      CodeUri: functions/leads_stream
      MemorySize: 512
      Timeout: 300
      Tracing: Active
      Role:
        'Fn::GetAtt':
          - Role
          - Arn
      Policies:
        - LambdaInvokePolicy:
            FunctionName: !Ref Map
        - LambdaInvokePolicy:
            FunctionName: !Ref Recommend
        - SNSPublishMessagePolicy:
            TopicName: !GetAtt InsertLeadTopic.TopicName
        - SNSPublishMessagePolicy:
            TopicName: !GetAtt LogLeadTopic.TopicName
        - SNSPublishMessagePolicy:
            TopicName: !GetAtt LogLeadInTopic.TopicName
        - SNSPublishMessagePolicy:
            TopicName: !GetAtt ErrorNotificationTopic.TopicName
      Environment:
        Variables:
          ENV: !Ref Env
          TOPIC_INSERT_LEAD: !Ref InsertLeadTopic
          TOPIC_LOG_LEAD: !Ref LogLeadTopic
          TOPIC_LOG_LEAD_IN: !Ref LogLeadInTopic
          TOPIC_ERROR: !Ref ErrorNotificationTopic
          TOPIC_ROLLBAR: !Ref RollbarTopic
          FUNC_MAP: !Ref Map
          FUNC_RECOMMEND: !Ref Recommend
          REDSHIFT_ENDPOINT: !Ref RedshiftDBEndpoint
          REDSHIFT_DB_USER: !Ref RedshiftDBUser
          REDSHIFT_DB_NAME: !Ref RedshiftDBName
          REDSHIFT_DB_PORT: !Ref RedshiftDBPort
          BUCKET: !Ref ProPairBucketName
          VELOCIFY_URL: https://service.leads360.com/ClientService.asmx/
      VpcConfig: 
        SecurityGroupIds: 
          - sg-0b54841712c67143c
          - sg-0409e987266b33345
        SubnetIds: 
          - subnet-072fb25b65d0098f2
          - subnet-08702ed2157ee7951
      Events:
        LeadStream:
          Type: Api
          Properties:
            Path: /leads_stream
            Method: post
          Authorizer:
            Type: "AWS::ApiGateway::Authorizer"
  IndexAccounts:
    Type: AWS::Serverless::Function
    Properties:
      Runtime: nodejs12.x
      Layers:
        - !Ref NodeJsLayer
      Handler: api.index
      CodeUri: functions/accounts
      Role:
        'Fn::GetAtt':
          - Role
          - Arn
      Timeout: 30
      Environment:
        Variables:
          ENV: !Ref Env
          REDSHIFT_ENDPOINT: !Ref RedshiftDBEndpoint
          REDSHIFT_DB_USER: !Ref RedshiftDBUser
          REDSHIFT_DB_NAME: !Ref RedshiftDBName
          REDSHIFT_DB_PORT: !Ref RedshiftDBPort
      Events:
        Index:
          Type: Api
          Properties:
            Path: /accounts
            Method: get
            RestApiId:
              Ref: AccountsAPI
      VpcConfig: 
        SecurityGroupIds: 
          - sg-0b54841712c67143c
          - sg-0409e987266b33345
        SubnetIds: 
          - subnet-072fb25b65d0098f2
          - subnet-08702ed2157ee7951
  ShowAccount:
    Type: AWS::Serverless::Function
    Properties:
      Runtime: nodejs12.x
      Layers:
        - !Ref NodeJsLayer
      Handler: api.show
      CodeUri: functions/accounts
      Role:
        'Fn::GetAtt':
          - Role
          - Arn
      Timeout: 30
      Environment:
        Variables:
          ENV: !Ref Env
          REDSHIFT_ENDPOINT: !Ref RedshiftDBEndpoint
          REDSHIFT_DB_USER: !Ref RedshiftDBUser
          REDSHIFT_DB_NAME: !Ref RedshiftDBName
          REDSHIFT_DB_PORT: !Ref RedshiftDBPort
      Events:
        Index:
          Type: Api
          Properties:
            Path: /accounts/{accountId}
            Method: get
            RestApiId:
                Ref: AccountsAPI
      VpcConfig: 
        SecurityGroupIds: 
          - sg-0b54841712c67143c
          - sg-0409e987266b33345
        SubnetIds: 
          - subnet-072fb25b65d0098f2
          - subnet-08702ed2157ee7951
  CreateAccount:
    Type: AWS::Serverless::Function
    Properties:
      Runtime: nodejs12.x
      Layers:
        - !Ref NodeJsLayer
      Handler: api.create
      CodeUri: functions/accounts
      Role:
        'Fn::GetAtt':
          - Role
          - Arn
      Timeout: 30
      Environment:
        Variables:
          ENV: !Ref Env
          REDSHIFT_ENDPOINT: !Ref RedshiftDBEndpoint
          REDSHIFT_DB_USER: !Ref RedshiftDBUser
          REDSHIFT_DB_NAME: !Ref RedshiftDBName
          REDSHIFT_DB_PORT: !Ref RedshiftDBPort
      Events:
        Index:
          Type: Api
          Properties:
            Path: /accounts
            Method: post
            RestApiId:
                Ref: AccountsAPI
      VpcConfig: 
        SecurityGroupIds: 
          - sg-0b54841712c67143c
          - sg-0409e987266b33345
        SubnetIds: 
          - subnet-072fb25b65d0098f2
          - subnet-08702ed2157ee7951
  UpdateAccount:
    Type: AWS::Serverless::Function
    Properties:
      Runtime: nodejs12.x
      Layers:
        - !Ref NodeJsLayer
      Handler: api.update
      CodeUri: functions/accounts
      Role:
        'Fn::GetAtt':
          - Role
          - Arn
      Timeout: 30
      Environment:
        Variables:
          ENV: !Ref Env
          REDSHIFT_ENDPOINT: !Ref RedshiftDBEndpoint
          REDSHIFT_DB_USER: !Ref RedshiftDBUser
          REDSHIFT_DB_NAME: !Ref RedshiftDBName
          REDSHIFT_DB_PORT: !Ref RedshiftDBPort
      Events:
        Index:
          Type: Api
          Properties:
            Path: /accounts/{accountId}
            Method: patch
            RestApiId:
                Ref: AccountsAPI
      VpcConfig: 
        SecurityGroupIds: 
          - sg-0b54841712c67143c
          - sg-0409e987266b33345
        SubnetIds: 
          - subnet-072fb25b65d0098f2
          - subnet-08702ed2157ee7951
  IndexAgents:
    Type: AWS::Serverless::Function
    Properties:
      Runtime: nodejs12.x
      Layers:
        - !Ref NodeJsLayer
      Handler: api.index
      CodeUri: functions/agents
      MemorySize: 512
      Role:
        'Fn::GetAtt':
          - Role
          - Arn
      Timeout: 30
      Environment:
        Variables:
          ENV: !Ref Env
          REDSHIFT_ENDPOINT: !Ref RedshiftDBEndpoint
          REDSHIFT_DB_USER: !Ref RedshiftDBUser
          REDSHIFT_DB_NAME: !Ref RedshiftDBName
          REDSHIFT_DB_PORT: !Ref RedshiftDBPort
      Events:
        Index:
          Type: Api
          Properties:
            Path: /agents
            Method: get
            RestApiId:
                Ref: AccountsAPI
      VpcConfig: 
        SecurityGroupIds: 
          - sg-0b54841712c67143c
          - sg-0409e987266b33345
        SubnetIds: 
          - subnet-072fb25b65d0098f2
          - subnet-08702ed2157ee7951
  ShowAgent:
    Type: AWS::Serverless::Function
    Properties:
      Runtime: nodejs12.x
      Layers:
        - !Ref NodeJsLayer
      Handler: api.show
      CodeUri: functions/agents
      Role:
        'Fn::GetAtt':
          - Role
          - Arn
      Timeout: 30
      Environment:
        Variables:
          ENV: !Ref Env
          REDSHIFT_ENDPOINT: !Ref RedshiftDBEndpoint
          REDSHIFT_DB_USER: !Ref RedshiftDBUser
          REDSHIFT_DB_NAME: !Ref RedshiftDBName
          REDSHIFT_DB_PORT: !Ref RedshiftDBPort
      Events:
        Index:
          Type: Api
          Properties:
            Path: /agents/{agentId}
            Method: get
            RestApiId:
              Ref: AccountsAPI
      VpcConfig: 
        SecurityGroupIds: 
          - sg-0b54841712c67143c
          - sg-0409e987266b33345
        SubnetIds: 
          - subnet-072fb25b65d0098f2
          - subnet-08702ed2157ee7951
  CreateAgent:
    Type: AWS::Serverless::Function
    Properties:
      Runtime: nodejs12.x
      Layers:
        - !Ref NodeJsLayer
      Handler: api.create
      CodeUri: functions/agents
      Role:
        'Fn::GetAtt':
          - Role
          - Arn
      Timeout: 30
      Environment:
        Variables:
          ENV: !Ref Env
          REDSHIFT_ENDPOINT: !Ref RedshiftDBEndpoint
          REDSHIFT_DB_USER: !Ref RedshiftDBUser
          REDSHIFT_DB_NAME: !Ref RedshiftDBName
          REDSHIFT_DB_PORT: !Ref RedshiftDBPort
      Events:
        Index:
          Type: Api
          Properties:
            Path: /agents
            Method: post
            RestApiId:
              Ref: AccountsAPI
      VpcConfig: 
        SecurityGroupIds: 
          - sg-0b54841712c67143c
          - sg-0409e987266b33345
        SubnetIds: 
          - subnet-072fb25b65d0098f2
          - subnet-08702ed2157ee7951

  CreateAgents:
    Type: AWS::Serverless::Function
    Properties:
      Runtime: nodejs12.x
      Layers:
        - !Ref NodeJsLayer
      Handler: api.create_agents
      CodeUri: functions/agents
      Role:
        'Fn::GetAtt':
          - Role
          - Arn
      Timeout: 30
      Environment:
        Variables:
          ENV: !Ref Env
          REDSHIFT_ENDPOINT: !Ref RedshiftDBEndpoint
          REDSHIFT_DB_USER: !Ref RedshiftDBUser
          REDSHIFT_DB_NAME: !Ref RedshiftDBName
          REDSHIFT_DB_PORT: !Ref RedshiftDBPort
      Events:
        Index:
          Type: Api
          Properties:
            Path: /agents/upload
            Method: post
            RestApiId:
              Ref: AccountsAPI
      VpcConfig: 
        SecurityGroupIds: 
          - sg-0b54841712c67143c
          - sg-0409e987266b33345
        SubnetIds: 
          - subnet-072fb25b65d0098f2
          - subnet-08702ed2157ee7951
  UpdateAgent:
    Type: AWS::Serverless::Function
    Properties:
      Runtime: nodejs12.x
      Layers:
        - !Ref NodeJsLayer
      Handler: api.update
      CodeUri: functions/agents
      Role:
        'Fn::GetAtt':
          - Role
          - Arn
      Timeout: 30
      Environment:
        Variables:
          ENV: !Ref Env
          REDSHIFT_ENDPOINT: !Ref RedshiftDBEndpoint
          REDSHIFT_DB_USER: !Ref RedshiftDBUser
          REDSHIFT_DB_NAME: !Ref RedshiftDBName
          REDSHIFT_DB_PORT: !Ref RedshiftDBPort
      Events:
        Index:
          Type: Api
          Properties:
            Path: /agents/{agentId}
            Method: patch
            RestApiId:
              Ref: AccountsAPI
      VpcConfig: 
        SecurityGroupIds: 
          - sg-0b54841712c67143c
          - sg-0409e987266b33345
        SubnetIds: 
          - subnet-072fb25b65d0098f2
          - subnet-08702ed2157ee7951

  UpdateAgents:
    Type: AWS::Serverless::Function
    Properties:
      Runtime: nodejs12.x
      Layers:
        - !Ref NodeJsLayer
      Handler: api.update_agents
      CodeUri: functions/agents
      Role:
        'Fn::GetAtt':
          - Role
          - Arn
      Timeout: 300
      Environment:
        Variables:
          ENV: !Ref Env
          REDSHIFT_ENDPOINT: !Ref RedshiftDBEndpoint
          REDSHIFT_DB_USER: !Ref RedshiftDBUser
          REDSHIFT_DB_NAME: !Ref RedshiftDBName
          REDSHIFT_DB_PORT: !Ref RedshiftDBPort
      Events:
        Index:
          Type: Api
          Properties:
            Path: /agents/upload
            Method: patch
            RestApiId:
              Ref: AccountsAPI
      VpcConfig: 
        SecurityGroupIds: 
          - sg-0b54841712c67143c
          - sg-0409e987266b33345
        SubnetIds: 
          - subnet-072fb25b65d0098f2
          - subnet-08702ed2157ee7951
  IndexBranches:
    Type: AWS::Serverless::Function
    Properties:
      Runtime: nodejs12.x
      Layers:
        - !Ref NodeJsLayer
      Handler: api.index
      CodeUri: functions/branches
      Role:
        'Fn::GetAtt':
          - Role
          - Arn
      Timeout: 30
      Environment:
        Variables:
          ENV: !Ref Env
          REDSHIFT_ENDPOINT: !Ref RedshiftDBEndpoint
          REDSHIFT_DB_USER: !Ref RedshiftDBUser
          REDSHIFT_DB_NAME: !Ref RedshiftDBName
          REDSHIFT_DB_PORT: !Ref RedshiftDBPort
      Events:
        Index:
          Type: Api
          Properties:
            Path: /branches
            Method: get
            RestApiId:
                Ref: AccountsAPI
      VpcConfig: 
        SecurityGroupIds: 
          - sg-0b54841712c67143c
          - sg-0409e987266b33345
        SubnetIds: 
          - subnet-072fb25b65d0098f2
          - subnet-08702ed2157ee7951
  CreateBranch:
    Type: AWS::Serverless::Function
    Properties:
      Runtime: nodejs12.x
      Layers:
        - !Ref NodeJsLayer
      Handler: api.create
      CodeUri: functions/branches
      Role:
        'Fn::GetAtt':
          - Role
          - Arn
      Timeout: 30
      Environment:
        Variables:
          ENV: !Ref Env
          REDSHIFT_ENDPOINT: !Ref RedshiftDBEndpoint
          REDSHIFT_DB_USER: !Ref RedshiftDBUser
          REDSHIFT_DB_NAME: !Ref RedshiftDBName
          REDSHIFT_DB_PORT: !Ref RedshiftDBPort
      Events:
        Index:
          Type: Api
          Properties:
            Path: /branches
            Method: post
            RestApiId:
              Ref: AccountsAPI
      VpcConfig: 
        SecurityGroupIds: 
          - sg-0b54841712c67143c
          - sg-0409e987266b33345
        SubnetIds: 
          - subnet-072fb25b65d0098f2
          - subnet-08702ed2157ee7951
  ShowBranch:
    Type: AWS::Serverless::Function
    Properties:
      Runtime: nodejs12.x
      Layers:
        - !Ref NodeJsLayer
      Handler: api.show
      CodeUri: functions/branches
      Role:
        'Fn::GetAtt':
          - Role
          - Arn
      Timeout: 30
      Environment:
        Variables:
          ENV: !Ref Env
          REDSHIFT_ENDPOINT: !Ref RedshiftDBEndpoint
          REDSHIFT_DB_USER: !Ref RedshiftDBUser
          REDSHIFT_DB_NAME: !Ref RedshiftDBName
          REDSHIFT_DB_PORT: !Ref RedshiftDBPort
      Events:
        Index:
          Type: Api
          Properties:
            Path: /branches/{branchId}
            Method: get
            RestApiId:
              Ref: AccountsAPI
      VpcConfig: 
        SecurityGroupIds: 
          - sg-0b54841712c67143c
          - sg-0409e987266b33345
        SubnetIds: 
          - subnet-072fb25b65d0098f2
          - subnet-08702ed2157ee7951
  UpdateBranch:
    Type: AWS::Serverless::Function
    Properties:
      Runtime: nodejs12.x
      Layers:
        - !Ref NodeJsLayer
      Handler: api.update
      CodeUri: functions/branches
      Role:
        'Fn::GetAtt':
          - Role
          - Arn
      Timeout: 30
      Environment:
        Variables:
          ENV: !Ref Env
          REDSHIFT_ENDPOINT: !Ref RedshiftDBEndpoint
          REDSHIFT_DB_USER: !Ref RedshiftDBUser
          REDSHIFT_DB_NAME: !Ref RedshiftDBName
          REDSHIFT_DB_PORT: !Ref RedshiftDBPort
      Events:
        Index:
          Type: Api
          Properties:
            Path: /branches/{branchId}
            Method: patch
            RestApiId:
              Ref: AccountsAPI
      VpcConfig: 
        SecurityGroupIds: 
          - sg-0b54841712c67143c
          - sg-0409e987266b33345
        SubnetIds: 
          - subnet-072fb25b65d0098f2
          - subnet-08702ed2157ee7951
  IndexBranchGroups:
    Type: AWS::Serverless::Function
    Properties:
      Runtime: nodejs12.x
      Layers:
        - !Ref NodeJsLayer
      Handler: api.index
      CodeUri: functions/branch_groups
      Role:
        'Fn::GetAtt':
          - Role
          - Arn
      Timeout: 30
      Environment:
        Variables:
          ENV: !Ref Env
          REDSHIFT_ENDPOINT: !Ref RedshiftDBEndpoint
          REDSHIFT_DB_USER: !Ref RedshiftDBUser
          REDSHIFT_DB_NAME: !Ref RedshiftDBName
          REDSHIFT_DB_PORT: !Ref RedshiftDBPort
      Events:
        Index:
          Type: Api
          Properties:
            Path: /branch_groups
            Method: get
            RestApiId:
                Ref: AccountsAPI
      VpcConfig: 
        SecurityGroupIds: 
          - sg-0b54841712c67143c
          - sg-0409e987266b33345
        SubnetIds: 
          - subnet-072fb25b65d0098f2
          - subnet-08702ed2157ee7951
  CreateBranchGroup:
    Type: AWS::Serverless::Function
    Properties:
      Runtime: nodejs12.x
      Layers:
        - !Ref NodeJsLayer
      Handler: api.create
      CodeUri: functions/branch_groups
      Role:
        'Fn::GetAtt':
          - Role
          - Arn
      Timeout: 30
      Environment:
        Variables:
          ENV: !Ref Env
          REDSHIFT_ENDPOINT: !Ref RedshiftDBEndpoint
          REDSHIFT_DB_USER: !Ref RedshiftDBUser
          REDSHIFT_DB_NAME: !Ref RedshiftDBName
          REDSHIFT_DB_PORT: !Ref RedshiftDBPort
      Events:
        Index:
          Type: Api
          Properties:
            Path: /branch_groups
            Method: post
            RestApiId:
              Ref: AccountsAPI
      VpcConfig: 
        SecurityGroupIds: 
          - sg-0b54841712c67143c
          - sg-0409e987266b33345
        SubnetIds: 
          - subnet-072fb25b65d0098f2
          - subnet-08702ed2157ee7951
  ShowBranchGroup:
    Type: AWS::Serverless::Function
    Properties:
      Runtime: nodejs12.x
      Layers:
        - !Ref NodeJsLayer
      Handler: api.show
      CodeUri: functions/branch_groups
      Role:
        'Fn::GetAtt':
          - Role
          - Arn
      Timeout: 30
      Environment:
        Variables:
          ENV: !Ref Env
          REDSHIFT_ENDPOINT: !Ref RedshiftDBEndpoint
          REDSHIFT_DB_USER: !Ref RedshiftDBUser
          REDSHIFT_DB_NAME: !Ref RedshiftDBName
          REDSHIFT_DB_PORT: !Ref RedshiftDBPort
      Events:
        Index:
          Type: Api
          Properties:
            Path: /branch_groups/{branchGroupId}
            Method: get
            RestApiId:
              Ref: AccountsAPI
      VpcConfig: 
        SecurityGroupIds: 
          - sg-0b54841712c67143c
          - sg-0409e987266b33345
        SubnetIds: 
          - subnet-072fb25b65d0098f2
          - subnet-08702ed2157ee7951
  UpdateBranchGroup:
    Type: AWS::Serverless::Function
    Properties:
      Runtime: nodejs12.x
      Layers:
        - !Ref NodeJsLayer
      Handler: api.update
      CodeUri: functions/branch_groups
      Role:
        'Fn::GetAtt':
          - Role
          - Arn
      Timeout: 30
      Environment:
        Variables:
          ENV: !Ref Env
          REDSHIFT_ENDPOINT: !Ref RedshiftDBEndpoint
          REDSHIFT_DB_USER: !Ref RedshiftDBUser
          REDSHIFT_DB_NAME: !Ref RedshiftDBName
          REDSHIFT_DB_PORT: !Ref RedshiftDBPort
      Events:
        Index:
          Type: Api
          Properties:
            Path: /branch_groups/{branchGroupId}
            Method: patch
            RestApiId:
              Ref: AccountsAPI
      VpcConfig: 
        SecurityGroupIds: 
          - sg-0b54841712c67143c
          - sg-0409e987266b33345
        SubnetIds: 
          - subnet-072fb25b65d0098f2
          - subnet-08702ed2157ee7951
  InsertRecord:
    Type: AWS::Serverless::Function
    Properties:
      Runtime: nodejs12.x
      Layers:
        - !Ref NodeJsLayer
      Handler: insert.handler
      CodeUri: functions/leads/insert
      MemorySize: 512
      Tracing: Active
      Role:
        'Fn::GetAtt':
          - Role
          - Arn
      Environment:
        Variables:
          ENV: !Ref Env
          BUCKET: !Ref ProPairBucketName
          REDSHIFT_ENDPOINT: !Ref RedshiftDBEndpoint
          REDSHIFT_DB_USER: !Ref RedshiftDBUser
          REDSHIFT_DB_NAME: !Ref RedshiftDBName
          REDSHIFT_DB_PORT: !Ref RedshiftDBPort
      VpcConfig: 
        SecurityGroupIds: 
          - sg-0b54841712c67143c
          - sg-0409e987266b33345
        SubnetIds: 
          - subnet-072fb25b65d0098f2
          - subnet-08702ed2157ee7951    
  LogLead:
    Type: AWS::Serverless::Function
    Properties:
      Runtime: nodejs12.x
      Layers:
        - !Ref NodeJsLayer
      Handler: log_lead_meta.handler
      CodeUri: functions/reporting/log_lead
      MemorySize: 512
      Timeout: 180
      Tracing: Active
      Role:
        'Fn::GetAtt':
          - Role
          - Arn
      Policies:
        - SNSPublishMessagePolicy:
            TopicName: !GetAtt ErrorNotificationTopic.TopicName
      Environment:
        Variables:
          ENV: !Ref Env
          BUCKET: !Ref ProPairBucketName
          TOPIC_ERROR: !Ref ErrorNotificationTopic
          REDSHIFT_DB_NAME: !Ref RedshiftDBName
          REDSHIFT_ENDPOINT: !Ref RedshiftDBEndpoint
          REDSHIFT_DB_USER: !Ref RedshiftDBUser
          REDSHIFT_DB_PORT: !Ref RedshiftDBPort
          AWS_USER: !Ref AWSUser
      VpcConfig: 
        SecurityGroupIds: 
          - sg-0b54841712c67143c
          - sg-0409e987266b33345
        SubnetIds: 
          - subnet-072fb25b65d0098f2
          - subnet-08702ed2157ee7951    
  Rollbar:
    Type: AWS::Serverless::Function
    Properties:
      Runtime: nodejs12.x
      Layers:
        - !Ref NodeJsLayer
      Handler: rollbar.handler
      CodeUri: functions/reporting/rollbar
      MemorySize: 512
      Timeout: 300
      Role:
        'Fn::GetAtt':
          - Role
          - Arn
      Environment:
        Variables:
          ENV: !Ref Env
          BUCKET: !Ref ProPairBucketName
          REDSHIFT_DBNAME: !Ref RedshiftDBName
          REDSHIFT_ENDPOINT: !Ref RedshiftDBEndpoint
          REDSHIFT_DBUSER: !Ref RedshiftDBUser
          REDSHIFT_DBPORT: !Ref RedshiftDBPort
          AWS_USER: !Ref AWSUser
      VpcConfig: 
        SecurityGroupIds: 
          - sg-0b54841712c67143c
          - sg-0409e987266b33345
        SubnetIds: 
          - subnet-072fb25b65d0098f2
          - subnet-08702ed2157ee7951 
  UpdateCampaigns:
    Type: AWS::Serverless::Function
    Properties:
      Runtime: nodejs12.x
      Layers:
        - !Ref NodeJsLayer
      Handler: update.update_database
      CodeUri: functions/campaigns
      MemorySize: 1512
      Timeout: 900
      Role:
        'Fn::GetAtt':
          - Role
          - Arn
      Environment:
        Variables:
          ENV: !Ref Env
          REDSHIFT_ENDPOINT: !Ref RedshiftDBEndpoint
          REDSHIFT_DB_USER: !Ref RedshiftDBUser
          REDSHIFT_DB_NAME: !Ref RedshiftDBName
          REDSHIFT_DB_PORT: !Ref RedshiftDBPort
          TOPIC_ROLLBAR: !Ref RollbarTopic
      VpcConfig: 
        SecurityGroupIds: 
          - sg-0b54841712c67143c
          - sg-0409e987266b33345
        SubnetIds: 
          - subnet-072fb25b65d0098f2
          - subnet-08702ed2157ee7951
  UpdateLookupsForCampaigns:
    Type: AWS::Serverless::Function
    Properties:
      Runtime: nodejs12.x
      Layers:
        - !Ref NodeJsLayer
      Handler: update.update_lookups
      CodeUri: functions/campaigns
      MemorySize: 1512
      Timeout: 900
      Role:
        'Fn::GetAtt':
            - Role
            - Arn
      Environment:
        Variables:
          ENV: !Ref Env
          REDSHIFT_ENDPOINT: !Ref RedshiftDBEndpoint
          REDSHIFT_DB_USER: !Ref RedshiftDBUser
          REDSHIFT_DB_NAME: !Ref RedshiftDBName
          REDSHIFT_DB_PORT: !Ref RedshiftDBPort
          TOPIC_ROLLBAR: !Ref RollbarTopic
      VpcConfig: 
        SecurityGroupIds: 
          - sg-0b54841712c67143c
          - sg-0409e987266b33345
        SubnetIds: 
          - subnet-072fb25b65d0098f2
          - subnet-08702ed2157ee7951
  UpdateStagingLookupsFiles:
    Type: AWS::Serverless::Function
    Condition: IsStaging
    Properties:
      Runtime: nodejs12.x
      Layers:
        - !Ref NodeJsLayer
      Handler: update.update_staging_folder
      CodeUri: functions/campaigns
      MemorySize: 512
      Timeout: 900
      Role:
        'Fn::GetAtt':
            - Role
            - Arn
      Environment:
        Variables:
          ENV: !Ref Env
          REDSHIFT_ENDPOINT: !Ref RedshiftDBEndpoint
          REDSHIFT_DB_USER: !Ref RedshiftDBUser
          REDSHIFT_DB_NAME: !Ref RedshiftDBName
          REDSHIFT_DB_PORT: !Ref RedshiftDBPort
          TOPIC_ROLLBAR: !Ref RollbarTopic
      VpcConfig: 
        SecurityGroupIds: 
          - sg-0b54841712c67143c
          - sg-0409e987266b33345
        SubnetIds: 
          - subnet-072fb25b65d0098f2
          - subnet-08702ed2157ee7951
  ReportRecommendations:
    Type: AWS::Serverless::Function
    Properties:
      Runtime: nodejs12.x
      Layers:
        - !Ref NodeJsLayer
      Handler: recommendations.handler
      CodeUri: functions/reporting
      MemorySize: 128
      Timeout: 300
      Tracing: Active
      Role:
        'Fn::GetAtt':
          - Role
          - Arn
      Events:
        GenerateReport:
          Type: Api
          Properties:
            Path: /reports/recommendations
            Method: get
          Authorizer:
            Type: "AWS::ApiGateway::Authorizer"
  ReportEvents:
    Type: AWS::Serverless::Function
    Properties:
      Runtime: nodejs12.x
      Layers:
        - !Ref NodeJsLayer
      Handler: events.handler
      CodeUri: functions/reporting
      MemorySize: 128
      Timeout: 300
      Tracing: Active
      Role:
        'Fn::GetAtt':
          - Role
          - Arn
      Events:
        GenerateReport:
          Type: Api
          Properties:
            Path: /reports/events
            Method: get
          Authorizer:
            Type: "AWS::ApiGateway::Authorizer"
  ReportSummaries:
    Type: AWS::Serverless::Function
    Properties:
      Runtime: nodejs12.x
      Layers:
        - !Ref NodeJsLayer
      Handler: summaries.handler
      CodeUri: functions/reporting
      MemorySize: 128
      Timeout: 300
      Tracing: Active
      Role:
        'Fn::GetAtt':
          - Role
          - Arn
      Events:
        GenerateReport:
          Type: Api
          Properties:
            Path: /reports/summaries
            Method: get
          Authorizer:
            Type: "AWS::ApiGateway::Authorizer"
  LogLeadIn:
    Type: AWS::Serverless::Function
    Properties:
      Runtime: nodejs12.x
      Layers:
        - !Ref NodeJsLayer
      Handler: log_lead_in.handler
      CodeUri: functions/reporting/log_lead_in
      MemorySize: 512
      Timeout: 900
      Tracing: Active
      Role:
        'Fn::GetAtt':
          - Role
          - Arn
      Environment:
        Variables:
          ENV: !Ref Env
          BUCKET: !Ref ProPairBucketName
          REDSHIFT_DB_NAME: !Ref RedshiftDBName
          REDSHIFT_ENDPOINT: !Ref RedshiftDBEndpoint
          REDSHIFT_DB_USER: !Ref RedshiftDBUser
          REDSHIFT_DB_PORT: !Ref RedshiftDBPort
      VpcConfig: 
        SecurityGroupIds: 
          - sg-0b54841712c67143c
          - sg-0409e987266b33345
        SubnetIds: 
          - subnet-072fb25b65d0098f2
          - subnet-08702ed2157ee7951   
  RepostLeads:
    Type: AWS::Serverless::Function
    Properties:
      Runtime: nodejs12.x
      Handler: repost_leads.handler
      CodeUri: functions/leads/repost
      Layers:
        - !Ref NodeJsLayer
      MemorySize: 512
      Timeout: 900
      Tracing: Active
      Role:
        'Fn::GetAtt':
          - Role
          - Arn
      Environment:
        Variables:
          ENV: !Ref Env
          BUCKET: !Ref ReportsBucketName
          BUCKET_LOGS: !Ref ProPairBucketName
          LEADS_ENDPOINT: 
            Fn::Join:
              - ""
              - - "https://"
                - Ref: "ServerlessRestApi"
                - ".execute-api.us-west-1.amazonaws.com/Stage/leads"
          VELOCIFY_URL: https://service.leads360.com/ClientService.asmx?wsdl
          TOPIC_ROLLBAR: !Ref RollbarTopic
      VpcConfig: 
        SecurityGroupIds: 
          - sg-0b54841712c67143c
          - sg-0409e987266b33345
        SubnetIds: 
          - subnet-072fb25b65d0098f2
          - subnet-08702ed2157ee7951
  RepostLeadsScheduler:
    Type: AWS::Serverless::Function
    Properties:
      Runtime: nodejs12.x
      Handler: scheduler.handler
      CodeUri: functions/leads/repost
      Layers:
        - !Ref NodeJsLayer
      MemorySize: 512
      Timeout: 900
      Tracing: Active
      Role:
        'Fn::GetAtt':
          - Role
          - Arn
      Policies:
        - LambdaInvokePolicy:
          FunctionName: !Ref RepostLeads
      Environment:
        Variables:
          ENV: !Ref Env
          REDSHIFT_ENDPOINT: !Ref RedshiftDBEndpoint
          REDSHIFT_DB_USER: !Ref RedshiftDBUser
          REDSHIFT_DB_NAME: !Ref RedshiftDBName
          REDSHIFT_DB_PORT: !Ref RedshiftDBPort
          FUNC_REPOST: !Ref RepostLeads
          LEADS_ENDPOINT: 
            Fn::Join:
              - ""
              - - "https://"
                - Ref: "ServerlessRestApi"
                - ".execute-api.us-west-1.amazonaws.com/Stage/leads"
          VELOCIFY_URL: https://service.leads360.com/ClientService.asmx?wsdl
          TOPIC_ROLLBAR: !Ref RollbarTopic
      VpcConfig: 
        SecurityGroupIds: 
          - sg-0b54841712c67143c
          - sg-0409e987266b33345
        SubnetIds: 
          - subnet-072fb25b65d0098f2
          - subnet-08702ed2157ee7951
  Map:
    Type: AWS::Serverless::Function
    Properties:
      Runtime: nodejs12.x
      Layers:
        - !Ref NodeJsLayer
      Handler: map.handler
      CodeUri: functions/leads/map
      MemorySize: 512
      Tracing: Active
      Timeout: 300
      Role:
        'Fn::GetAtt':
          - Role
          - Arn
      Environment:
        Variables:
          ENV: !Ref Env
          REDSHIFT_ENDPOINT: !Ref RedshiftDBEndpoint
          REDSHIFT_DB_USER: !Ref RedshiftDBUser
          REDSHIFT_DB_NAME: !Ref RedshiftDBName
          REDSHIFT_DB_PORT: !Ref RedshiftDBPort
          TOPIC_ROLLBAR: !Ref RollbarTopic
      VpcConfig: 
        SecurityGroupIds: 
          - sg-0b54841712c67143c
          - sg-0409e987266b33345
        SubnetIds: 
          - subnet-072fb25b65d0098f2
          - subnet-08702ed2157ee7951
  Recommend:
    Type: AWS::Serverless::Function
    Properties:
      Runtime: python2.7
      Handler: recommend.recommend
      CodeUri: functions/leads/recommend
      MemorySize: 3008
      Timeout: 900
      Tracing: Active
      Role:
        'Fn::GetAtt':
          - Role
          - Arn
      Environment:
        Variables:
          ENV: !Ref Env
          TOPIC_ERROR: !Ref ErrorNotificationTopic
          TOPIC_ROLLBAR: !Ref RollbarTopic
          BUCKET: !Ref ProPairBucketName
          REDSHIFT_ENDPOINT: !Ref RedshiftDBEndpoint
          REDSHIFT_DB_USER: !Ref RedshiftDBUser
          REDSHIFT_DB_NAME: !Ref RedshiftDBName
          REDSHIFT_DB_PORT: !Ref RedshiftDBPort
      VpcConfig: 
        SecurityGroupIds: 
          - sg-0b54841712c67143c
          - sg-0409e987266b33345
        SubnetIds: 
          - subnet-072fb25b65d0098f2
          - subnet-08702ed2157ee7951
      Policies:
        - SNSPublishMessagePolicy:
            TopicName: !GetAtt ErrorNotificationTopic.TopicName
  DirectMail:
    Type: AWS::Serverless::Function
    Properties:
      Runtime: python2.7
      Handler: direct_mail.direct_mail
      CodeUri: functions/leads/recommend
      MemorySize: 3008
      Timeout: 900
      Tracing: Active
      Role:
        'Fn::GetAtt':
          - Role
          - Arn
      Environment:
        Variables:
          ENV: !Ref Env
          TOPIC_ERROR: !Ref ErrorNotificationTopic
          TOPIC_ROLLBAR: !Ref RollbarTopic
          BUCKET: !Ref ProPairBucketName
          REDSHIFT_ENDPOINT: !Ref RedshiftDBEndpoint
          REDSHIFT_DB_USER: !Ref RedshiftDBUser
          REDSHIFT_DB_NAME: !Ref RedshiftDBName
          REDSHIFT_DB_PORT: !Ref RedshiftDBPort
      VpcConfig: 
        SecurityGroupIds: 
          - sg-0b54841712c67143c
          - sg-0409e987266b33345
        SubnetIds: 
          - subnet-072fb25b65d0098f2
          - subnet-08702ed2157ee7951
      Policies:
        - SNSPublishMessagePolicy:
            TopicName: !GetAtt ErrorNotificationTopic.TopicName
  ProcessDirectMail:
    Type: AWS::Serverless::Function
    Properties:
      Runtime: nodejs12.x
      Layers:
        - !Ref NodeJsLayer
      Handler: api.handler
      CodeUri: functions/leads/direct_mail
      MemorySize: 512
      Tracing: Active
      Timeout: 900
      Role:
        'Fn::GetAtt':
          - Role
          - Arn
      Policies:
        - LambdaInvokePolicy:
          FunctionName: !Ref DirectMail
      Environment:
        Variables:
          ENV: !Ref Env
          BUCKET: !Ref ProPairBucketName
          REDSHIFT_ENDPOINT: !Ref RedshiftDBEndpoint
          REDSHIFT_DB_USER: !Ref RedshiftDBUser
          REDSHIFT_DB_NAME: !Ref RedshiftDBName
          REDSHIFT_DB_PORT: !Ref RedshiftDBPort
          FUNC_DIRECT_MAIL: !Ref DirectMail
          TOPIC_ROLLBAR: !Ref RollbarTopic
      VpcConfig: 
        SecurityGroupIds: 
          - sg-0b54841712c67143c
          - sg-0409e987266b33345
        SubnetIds: 
          - subnet-072fb25b65d0098f2
          - subnet-08702ed2157ee7951
  MailSentAudit:
    Type: AWS::Serverless::Function
    Properties:
      Runtime: nodejs12.x
      Layers:
        - !Ref NodeJsLayer
      Handler: audit.handler
      CodeUri: functions/leads/direct_mail
      MemorySize: 512
      Tracing: Active
      Timeout: 900
      Role:
        'Fn::GetAtt':
          - Role
          - Arn
      Environment:
        Variables:
          ENV: !Ref Env
          BUCKET: epastor01
          REDSHIFT_ENDPOINT: !Ref RedshiftDBEndpoint
          REDSHIFT_DB_USER: !Ref RedshiftDBUser
          REDSHIFT_DB_NAME: !Ref RedshiftDBName
          REDSHIFT_DB_PORT: !Ref RedshiftDBPort
          TOPIC_DIRECT_MAIL: !Ref DirectMailTopic
          TOPIC_ROLLBAR: !Ref RollbarTopic
      VpcConfig: 
        SecurityGroupIds: 
          - sg-0b54841712c67143c
          - sg-0409e987266b33345
        SubnetIds: 
          - subnet-072fb25b65d0098f2
          - subnet-08702ed2157ee7951
  UpdateAthenaPartitions:
    Type: AWS::Serverless::Function
    Properties:
      Runtime: nodejs12.x
      Layers:
        - !Ref NodeJsLayer
      Handler: update_partitions.handler
      CodeUri: functions/reporting
      MemorySize: 128
      Tracing: Active
      Timeout: 30
      Role:
        'Fn::GetAtt':
          - Role
          - Arn
      Environment:
        Variables:
          ATHENA_DB_NAME: !Ref AthenaDBName
          BUCKET: !Ref ReportsBucketName
  ExpandRecommendation:
    Type: AWS::Serverless::Function
    Properties:
      Runtime: python3.7
      Layers:
        - !Ref Python3Layer
      Handler: expand_rec.expand
      CodeUri: functions/leads/expand_recommendation_string
      MemorySize: 3008
      Timeout: 900
      Role:
        'Fn::GetAtt':
          - Role
          - Arn
      Environment:
        Variables:
          ENV: !Ref Env
          REDSHIFT_ENDPOINT: !Ref RedshiftDBEndpoint
          REDSHIFT_DB_USER: !Ref RedshiftDBUser
          REDSHIFT_DB_NAME: !Ref RedshiftDBName
          REDSHIFT_DB_PORT: !Ref RedshiftDBPort
          BUCKET: !Ref ProPairBucketName
          TOPIC_ROLLBAR: !Ref RollbarTopic   
      VpcConfig: 
        SecurityGroupIds: 
          - sg-0b54841712c67143c
          - sg-0409e987266b33345
        SubnetIds: 
          - subnet-072fb25b65d0098f2
          - subnet-08702ed2157ee7951
  ExpandRecommendationScheduler:
    Type: AWS::Serverless::Function
    Properties:
      Runtime: python3.7
      Layers:
        - !Ref Python3Layer
      Handler: scheduler.update
      CodeUri: functions/leads/expand_recommendation_string
      MemorySize: 256
      Timeout: 300
      Role:
        'Fn::GetAtt':
          - Role
          - Arn
      Environment:
        Variables:
          ENV: !Ref Env
          REDSHIFT_ENDPOINT: !Ref RedshiftDBEndpoint
          REDSHIFT_DB_USER: !Ref RedshiftDBUser
          REDSHIFT_DB_NAME: !Ref RedshiftDBName
          REDSHIFT_DB_PORT: !Ref RedshiftDBPort
          BUCKET: !Ref ProPairBucketName
          TOPIC_REC_EXPANSION: !Ref ExpandRecommendationTopic   
      VpcConfig: 
        SecurityGroupIds: 
          - sg-0b54841712c67143c
          - sg-0409e987266b33345
        SubnetIds: 
          - subnet-072fb25b65d0098f2
          - subnet-08702ed2157ee7951
  MortgageRateUpdater:
    Type: AWS::Serverless::Function
    Properties:
      Runtime: python3.7
      Layers:
        - !Ref Python3Layer
      Handler: updater.update
      CodeUri: functions/mortgage_rate/
      MemorySize: 256
      Timeout: 300
      Tracing: Active
      Role:
        'Fn::GetAtt':
          - Role
          - Arn
      Environment:
        Variables:
          ENV: !Ref Env
          REDSHIFT_ENDPOINT: !Ref RedshiftDBEndpoint
          REDSHIFT_DB_USER: !Ref RedshiftDBUser
          REDSHIFT_DB_NAME: !Ref RedshiftDBName
          REDSHIFT_DB_PORT: !Ref RedshiftDBPort
          TOPIC_ROLLBAR: !Ref RollbarTopic
      VpcConfig: 
        SecurityGroupIds: 
          - sg-0b54841712c67143c
          - sg-0409e987266b33345
        SubnetIds: 
          - subnet-072fb25b65d0098f2
          - subnet-08702ed2157ee7951
  DailySREReport:
    Type: AWS::Serverless::Function
    Properties:
      Runtime: nodejs12.x
      Layers:
        - !Ref NodeJsLayer
      Handler: daily_sre.handler
      CodeUri: functions/reporting/request_verification
      MemorySize: 256
      Timeout: 300
      Tracing: Active
      Role:
        'Fn::GetAtt':
          - Role
          - Arn
      Environment:
        Variables:
          BUCKET: !Ref ReportsBucketName
          BUCKET_LOGS: !Ref ProPairBucketName
          ENV: !Ref Env
          REDSHIFT_ENDPOINT: !Ref RedshiftDBEndpoint
          REDSHIFT_DB_USER: !Ref RedshiftDBUser
          REDSHIFT_DB_NAME: !Ref RedshiftDBName
          REDSHIFT_DB_PORT: !Ref RedshiftDBPort
      VpcConfig: 
        SecurityGroupIds: 
          - sg-0b54841712c67143c
          - sg-0409e987266b33345
        SubnetIds: 
          - subnet-072fb25b65d0098f2
          - subnet-08702ed2157ee7951
  GenerateSandboxLeads:
    Type: AWS::Serverless::Function
    Properties:
      Runtime: python3.7
      Layers:
        - !Ref Python3Layer
      Handler: generator.main
      CodeUri: functions/data_architecture/lead_generator
      MemorySize: 3008
      Timeout: 300
      Role:
        'Fn::GetAtt':
        - Role
        - Arn
      Environment:
        Variables:
          ENV: !Ref Env
          REDSHIFT_ENDPOINT: !Ref RedshiftDBEndpoint
          REDSHIFT_DB_USER: !Ref RedshiftDBUser
          REDSHIFT_DB_NAME: !Ref RedshiftDBName
          REDSHIFT_DB_PORT: !Ref RedshiftDBPort
          LEADS_ENDPOINT: 
            Fn::Join:
              - ""
              - - "https://"
                - Ref: "ServerlessRestApi"
                - ".execute-api.us-west-1.amazonaws.com/Stage/leads"
      VpcConfig: 
        SecurityGroupIds: 
          - sg-0b54841712c67143c
          - sg-0409e987266b33345
        SubnetIds: 
          - subnet-072fb25b65d0098f2
          - subnet-08702ed2157ee7951
    Condition: IsStaging
  LeadsAudit:
    Type: AWS::Serverless::Function
    Properties:
      Runtime: python3.7
      Layers:
        - !Ref Python3Layer
      Handler: leads_producer_audit.update
      CodeUri: functions/data_architecture/leads
      MemorySize: 3008
      Timeout: 900
      Role:
        'Fn::GetAtt':
          - Role
          - Arn
      Environment:
        Variables:
          ENV: !Ref Env
          REDSHIFT_ENDPOINT: !Ref RedshiftDBEndpoint
          REDSHIFT_DB_USER: !Ref RedshiftDBUser
          REDSHIFT_DB_NAME: !Ref RedshiftDBName
          REDSHIFT_DB_PORT: !Ref RedshiftDBPort
          TOPIC_ROLLBAR: !Ref RollbarTopic
      VpcConfig: 
        SecurityGroupIds: 
          - sg-0b54841712c67143c
          - sg-0409e987266b33345
        SubnetIds: 
          - subnet-072fb25b65d0098f2
          - subnet-08702ed2157ee7951
  LeadsAuditScheduler:
    Type: AWS::Serverless::Function
    Properties:
      Runtime: python2.7
      Layers:
        - !Ref PythonLayer
      Handler: audit_scheduler.update
      CodeUri: functions/data_architecture/leads
      MemorySize: 3008
      Timeout: 300
      Role:
        'Fn::GetAtt':
          - Role
          - Arn
      Environment:
        Variables:
          ENV: !Ref Env
          REDSHIFT_ENDPOINT: !Ref RedshiftDBEndpoint
          REDSHIFT_DB_USER: !Ref RedshiftDBUser
          REDSHIFT_DB_NAME: !Ref RedshiftDBName
          REDSHIFT_DB_PORT: !Ref RedshiftDBPort
          TOPIC_LEADS_AUDIT: !Ref LeadsAuditTopic
          TOPIC_ROLLBAR: !Ref RollbarTopic
      VpcConfig: 
        SecurityGroupIds: 
          - sg-0b54841712c67143c
          - sg-0409e987266b33345
        SubnetIds: 
          - subnet-072fb25b65d0098f2
          - subnet-08702ed2157ee7951
  DataArchitectureLeadsRedshift:
    Type: AWS::Serverless::Function
    Properties:
      Runtime: python3.7
      Layers:
        - !Ref Python3Layer
      Handler: leads_producer.update
      CodeUri: functions/data_architecture/leads
      MemorySize: 3008
      Timeout: 900
      Role:
        'Fn::GetAtt':
          - Role
          - Arn
      Environment:
        Variables:
          ENV: !Ref Env
          BUCKET: epastor01
          REDSHIFT_ENDPOINT: !Ref RedshiftDBEndpoint
          REDSHIFT_DB_USER: !Ref RedshiftDBUser
          REDSHIFT_DB_NAME: !Ref RedshiftDBName
          REDSHIFT_DB_PORT: !Ref RedshiftDBPort
          TOPIC_ROLLBAR: !Ref RollbarTopic
      VpcConfig: 
        SecurityGroupIds: 
          - sg-0b54841712c67143c
          - sg-0409e987266b33345
        SubnetIds: 
          - subnet-072fb25b65d0098f2
          - subnet-08702ed2157ee7951
  DataArchitectureLeadsScheduler:
    Type: AWS::Serverless::Function
    Properties:
      Runtime: python2.7
      Layers:
        - !Ref PythonLayer
      Handler: scheduler.update
      CodeUri: functions/data_architecture/leads
      MemorySize: 3008
      Timeout: 300
      Role:
        'Fn::GetAtt':
          - Role
          - Arn
      Environment:
        Variables:
          ENV: !Ref Env
          REDSHIFT_ENDPOINT: !Ref RedshiftDBEndpoint
          REDSHIFT_DB_USER: !Ref RedshiftDBUser
          REDSHIFT_DB_NAME: !Ref RedshiftDBName
          REDSHIFT_DB_PORT: !Ref RedshiftDBPort
          #TOPIC_DATA_ARCH_LEADS: !Ref DataArchitectureLeadsTopic
          TOPIC_DATA_ARCH_LEADS_REDSHIFT: !Ref DataArchitectureLeadsRedshiftTopic
          TOPIC_ROLLBAR: !Ref RollbarTopic
      VpcConfig: 
        SecurityGroupIds: 
          - sg-0b54841712c67143c
          - sg-0409e987266b33345
        SubnetIds: 
          - subnet-072fb25b65d0098f2
          - subnet-08702ed2157ee7951
  DataArchitectureEventsRedshift:
    Type: AWS::Serverless::Function
    Properties:
      Runtime: python3.7
      Layers:
        - !Ref Python3Layer
      Handler: events_producer.update
      CodeUri: functions/data_architecture/events
      MemorySize: 3008
      Timeout: 900
      Role:
        'Fn::GetAtt':
          - Role
          - Arn
      Environment:
        Variables:
          ENV: !Ref Env
          REDSHIFT_ENDPOINT: !Ref RedshiftDBEndpoint
          REDSHIFT_DB_USER: !Ref RedshiftDBUser
          REDSHIFT_DB_NAME: !Ref RedshiftDBName
          REDSHIFT_DB_PORT: !Ref RedshiftDBPort
          TOPIC_ROLLBAR: !Ref RollbarTopic
      VpcConfig: 
        SecurityGroupIds: 
          - sg-0b54841712c67143c
          - sg-0409e987266b33345
        SubnetIds: 
          - subnet-072fb25b65d0098f2
          - subnet-08702ed2157ee7951
  DataArchitectureEventsScheduler:
    Type: AWS::Serverless::Function
    Properties:
      Runtime: python3.7
      Layers:
        - !Ref Python3Layer
      Handler: scheduler.update
      CodeUri: functions/data_architecture/events
      MemorySize: 512
      Timeout: 900
      Role:
        'Fn::GetAtt':
          - Role
          - Arn
      Environment:
        Variables:
          ENV: !Ref Env
          REDSHIFT_ENDPOINT: !Ref RedshiftDBEndpoint
          REDSHIFT_DB_USER: !Ref RedshiftDBUser
          REDSHIFT_DB_NAME: !Ref RedshiftDBName
          REDSHIFT_DB_PORT: !Ref RedshiftDBPort
          TOPIC_ROLLBAR: !Ref RollbarTopic
          TOPIC_DATA_ARCH_EVENTS: !Ref DataArchitectureEventsTopic
      VpcConfig: 
        SecurityGroupIds: 
          - sg-0b54841712c67143c
          - sg-0409e987266b33345
        SubnetIds: 
          - subnet-072fb25b65d0098f2
          - subnet-08702ed2157ee7951
  DataArchitectureEncompass:
    Type: AWS::Serverless::Function
    Properties:
      Runtime: python3.7
      Layers:
        - !Ref Python3Layer
      Handler: encompass.update
      CodeUri: functions/data_architecture/encompass
      MemorySize: 3008
      Timeout: 300
      Role:
        'Fn::GetAtt':
          - Role
          - Arn
      Environment:
        Variables:
          ENV: !Ref Env
          BUCKET: epastor01
          REDSHIFT_ENDPOINT: !Ref RedshiftDBEndpoint
          REDSHIFT_DB_USER: !Ref RedshiftDBUser
          REDSHIFT_DB_NAME: !Ref RedshiftDBName
          REDSHIFT_DB_PORT: !Ref RedshiftDBPort
          TOPIC_ROLLBAR: !Ref RollbarTopic
      VpcConfig: 
        SecurityGroupIds: 
          - sg-0b54841712c67143c
          - sg-0409e987266b33345
        SubnetIds: 
          - subnet-072fb25b65d0098f2
          - subnet-08702ed2157ee7951
  HRUpdates:
    Type: AWS::Serverless::Function
    Properties:
      Runtime: python3.7
      Layers:
        - !Ref Python3Layer
      Handler: hr_updates.update
      CodeUri: functions/data_architecture/agent_profiles
      MemorySize: 3008
      Timeout: 900
      Role:
        'Fn::GetAtt':
          - Role
          - Arn
      Environment:
        Variables:
          ENV: !Ref Env
          REDSHIFT_ENDPOINT: !Ref RedshiftDBEndpoint
          REDSHIFT_DB_USER: !Ref RedshiftDBUser
          REDSHIFT_DB_NAME: !Ref RedshiftDBName
          REDSHIFT_DB_PORT: !Ref RedshiftDBPort
          TOPIC_ROLLBAR: !Ref RollbarTopic
      VpcConfig: 
        SecurityGroupIds: 
          - sg-0b54841712c67143c
          - sg-0409e987266b33345
        SubnetIds: 
          - subnet-072fb25b65d0098f2
          - subnet-08702ed2157ee7951
  DataArchitectureCallsRedshift:
    Type: AWS::Serverless::Function
    Properties:
      Runtime: python3.7
      Layers:
        - !Ref Python3Layer
      Handler: calls_producer.update
      CodeUri: functions/data_architecture/calls
      MemorySize: 3008
      Timeout: 900
      Role:
        'Fn::GetAtt':
          - Role
          - Arn
      Environment:
        Variables:
          ENV: !Ref Env
          REDSHIFT_ENDPOINT: !Ref RedshiftDBEndpoint
          REDSHIFT_DB_USER: !Ref RedshiftDBUser
          REDSHIFT_DB_NAME: !Ref RedshiftDBName
          REDSHIFT_DB_PORT: !Ref RedshiftDBPort
          TOPIC_ROLLBAR: !Ref RollbarTopic
      VpcConfig: 
        SecurityGroupIds: 
          - sg-0b54841712c67143c
          - sg-0409e987266b33345
        SubnetIds: 
          - subnet-072fb25b65d0098f2
          - subnet-08702ed2157ee7951
  DataArchitectureCallsScheduler:
    Type: AWS::Serverless::Function
    Properties:
      Runtime: python2.7
      Layers:
        - !Ref PythonLayer
      Handler: scheduler.update
      CodeUri: functions/data_architecture/calls
      MemorySize: 3008
      Timeout: 300
      Role:
        'Fn::GetAtt':
          - Role
          - Arn
      Environment:
        Variables:
          ENV: !Ref Env
          REDSHIFT_ENDPOINT: !Ref RedshiftDBEndpoint
          REDSHIFT_DB_USER: !Ref RedshiftDBUser
          REDSHIFT_DB_NAME: !Ref RedshiftDBName
          REDSHIFT_DB_PORT: !Ref RedshiftDBPort
          TOPIC_DATA_ARCH_CALLS_REDSHIFT: !Ref DataArchitectureCallsRedshiftTopic
          TOPIC_ROLLBAR: !Ref RollbarTopic
      VpcConfig: 
        SecurityGroupIds: 
          - sg-0b54841712c67143c
          - sg-0409e987266b33345
        SubnetIds: 
          - subnet-072fb25b65d0098f2
          - subnet-08702ed2157ee7951
  MixTiers:
    Type: AWS::Serverless::Function
    Properties:
      Runtime: python3.7
      Layers:
        - !Ref Python3Layer
      Handler: handler.main
      CodeUri: functions/leads/mix
      MemorySize: 3008
      Timeout: 900
      Role:
        'Fn::GetAtt':
          - Role
          - Arn
      Environment:
        Variables:
          ENV: !Ref Env
          TOPIC_ROLLBAR: !Ref RollbarTopic
      VpcConfig: 
        SecurityGroupIds: 
          - sg-0b54841712c67143c
          - sg-0409e987266b33345
        SubnetIds: 
          - subnet-072fb25b65d0098f2
          - subnet-08702ed2157ee7951
  MixTiersScheduler:
    Type: AWS::Serverless::Function
    Properties:
      Runtime: python3.7
      Layers:
        - !Ref Python3Layer
      Handler: scheduler.update
      CodeUri: functions/leads/mix
      MemorySize: 512
      Timeout: 150
      Role:
        'Fn::GetAtt':
          - Role
          - Arn
      Environment:
        Variables:
          ENV: !Ref Env
          TOPIC_MIX_TIERS: !Ref MixTiersTopic
          TOPIC_ROLLBAR: !Ref RollbarTopic
      VpcConfig: 
        SecurityGroupIds: 
          - sg-0b54841712c67143c
          - sg-0409e987266b33345
        SubnetIds: 
          - subnet-072fb25b65d0098f2
          - subnet-08702ed2157ee7951

